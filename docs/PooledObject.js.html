<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>PooledObject.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Pool.html">Pool</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Pool.html#acquire">acquire</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Pool.html#clear">clear</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Pool.html#getInfo">getInfo</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Pool.html#getOptions">getOptions</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Pool.html#getSize">getSize</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Pool.html#getState">getState</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Pool.html#has">has</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Pool.html#isBorrowed">isBorrowed</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Pool.html#release">release</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Pool.html#releaseAndDestroy">releaseAndDestroy</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Pool.html#start">start</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Pool.html#stop">stop</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Pool.html#use">use</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="PooledObject.html">PooledObject</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PooledObject.html#getIdleTime">getIdleTime</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PooledObject.html#getLoanPromise">getLoanPromise</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PooledObject.html#getObject">getObject</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PooledObject.html#getState">getState</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PooledObject.html#setToAvailable">setToAvailable</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PooledObject.html#setToBorrowed">setToBorrowed</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PooledObject.html#setToDestroyed">setToDestroyed</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PooledObject.html#setToInvalid">setToInvalid</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PooledObject.html#setToReturned">setToReturned</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PooledObject.html#setToValidating">setToValidating</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="PoolRequest.html">PoolRequest</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PoolRequest.html#didTimeout">didTimeout</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PoolRequest.html#getPromise">getPromise</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PoolRequest.html#hasTimeout">hasTimeout</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PoolRequest.html#reject">reject</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PoolRequest.html#resolve">resolve</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="TimeoutError.html">TimeoutError</a></span></li><li class="nav-heading">Events</li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="Pool.html#event:factoryCreateError">factoryCreateError</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="Pool.html#event:factoryDestroyError">factoryDestroyError</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="Pool.html#event:factoryValidateError">factoryValidateError</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="Pool.html#event:poolDidStart">poolDidStart</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="Pool.html#event:poolDidStop">poolDidStop</a></span></li><li class="nav-heading">Interfaces</li><li class="nav-heading"><span class="nav-item-type type-interface">I</span><span class="nav-item-name"><a href="Factory.html">Factory</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Factory.html#create">create</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Factory.html#destroy">destroy</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Factory.html#validate">validate</a></span></li><li class="nav-heading"><span class="nav-item-type type-interface">I</span><span class="nav-item-name"><a href="ObjectQueue.html">ObjectQueue</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ObjectQueue.html#peek">peek</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ObjectQueue.html#pop">pop</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ObjectQueue.html#push">push</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ObjectQueue.html#shift">shift</a></span></li><li class="nav-heading"><span class="nav-item-type type-interface">I</span><span class="nav-item-name"><a href="Options.html">Options</a></span></li><li class="nav-heading"><span class="nav-item-type type-interface">I</span><span class="nav-item-name"><a href="RequestQueue.html">RequestQueue</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="RequestQueue.html#dequeue">dequeue</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="RequestQueue.html#enqueue">enqueue</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="RequestQueue.html#remove">remove</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">PooledObject.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const { ObjectStates } = require('./constants');
const { ErrorMessages } = require('./errors');

/**
 * A wrapped object with an updatable state
 * @example
 * // Create a pooled object and changes it's state to AVAILABLE
 * const thingy = new Thingy()
 * const pooledObject = new PooledObject(thingy)
 * pooledObject.setToAvailable()
 *
 * @template {object} T
 */
class PooledObject {
  /**
   * @param {T} object The object being pooled
   * @param {function():number} [getTimestamp=Date.now] Function to get the current timestamp. See [Date.now()]{@link https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date/now}
   */
  constructor(object, getTimestamp = Date.now) {
    if (!object || typeof object !== 'object') throw new TypeError(ErrorMessages.NO_OBJECT);

    /**
     * Function to get the current timestamp
     * @type {function():number}
     */
    this._getTimestamp = getTimestamp;

    /**
     * The wrapped object
     * @type {T}
     */
    this._object = object;

    /**
     * The current object state
     * @type {number}
     */
    this._state = ObjectStates.CREATED;

    /**
     * Timestamp for when the object was created
     * @type {number}
     */
    this._createdAt = this._getTimestamp();

    /**
     * Timestamp for last time state was changed to `AVAILABLE`
     * @type {number}
     */
    this._availableAt = 0;

    /**
     * Timestamp for last time state was changed to `BORROWED`
     * @type {number}
     */
    this._borrowedAt = 0;

    /**
     * Promise attached to the pooled object when it is borrowed representing a loan
     * @type {Promise&lt;void>}
     */
    //@ts-ignore
    this._loanPromise = null;

    /**
     * Promise resolve function to be called when the pooled object is returned
     * @type {function}
     */
    //@ts-ignore
    this._loanResolve = null;
  }

  /**
   * Changes state to `AVAILABLE`
   * @returns {this}
   */
  setToAvailable() {
    if (this._state === ObjectStates.AVAILABLE) return this;
    if (this._state >= ObjectStates.BORROWED) {
      if (this._state === ObjectStates.BORROWED) throw new TypeError(ErrorMessages.MUST_RETURN_BEFORE_AVAILABLE);
      if (this._state === ObjectStates.INVALID) throw new TypeError(ErrorMessages.OBJECT_IS_INVALID);
      throw new TypeError(ErrorMessages.OBJECT_IS_DESTROYED);
    }
    this._state = ObjectStates.AVAILABLE;
    this._availableAt = this._getTimestamp();
    return this;
  }

  /**
   * Changes state to `BORROWED` and attaches a promise to the pooled object which gets resolved on setToReturned
   * @returns {this}
   */
  setToBorrowed() {
    if (this._state !== ObjectStates.AVAILABLE) throw new TypeError(ErrorMessages.CANT_BORROW_NOT_AVAILABLE);
    this._loanPromise = new Promise(resolve => {
      this._loanResolve = resolve;
    });
    this._state = ObjectStates.BORROWED;
    this._borrowedAt = this._getTimestamp();
    return this;
  }

  /**
   * Changes state to `RETURNED` and resolves the loan promise
   * @returns {this}
   */
  setToReturned() {
    if (this._state !== ObjectStates.BORROWED) throw new TypeError(ErrorMessages.CANT_RETURN_NOT_BORROWED);
    this._loanResolve();
    this._state = ObjectStates.RETURNED;
    return this;
  }

  /**
   * Changes state to `VALIDATING`
   * @returns {this}
   */
  setToValidating() {
    if (this._state >= ObjectStates.BORROWED) {
      if (this._state === ObjectStates.BORROWED) throw new TypeError(ErrorMessages.CANT_VALIDATE_BORROWED);
      if (this._state === ObjectStates.INVALID) throw new TypeError(ErrorMessages.OBJECT_IS_INVALID);
      throw new TypeError(ErrorMessages.OBJECT_IS_DESTROYED);
    }
    this._state = ObjectStates.VALIDATING;
    return this;
  }

  /**
   * Changes state to `INVALID`
   * @returns {this}
   */
  setToInvalid() {
    if (this._state === ObjectStates.DESTROYED) throw new TypeError(ErrorMessages.OBJECT_IS_DESTROYED);
    this._state = ObjectStates.INVALID;
    return this;
  }

  /**
   * Changes state to `DESTROYED`
   * @returns {this}
   */

  setToDestroyed() {
    this._state = ObjectStates.DESTROYED;
    return this;
  }

  /**
   * The object that is pooled
   * @returns {T}
   */
  getObject() {
    return this._object;
  }

  /**
   * Current state of the pooled object
   * @returns {ObjectState}
   */
  getState() {
    return ObjectStates[this._state];
  }

  /**
   * Promise that will be resolved when object gets returned. Returns `null` if not `BORROWED`
   * @returns {Promise&lt;void>|null}
   */
  getLoanPromise() {
    if (this._state !== ObjectStates.BORROWED) return null;
    return this._loanPromise;
  }

  /**
   * The number of milliseconds since set to `AVAILABLE`. Returns `-1` if not `AVAILABLE`
   * @returns {number}
   */
  getIdleTime() {
    if (this._state !== ObjectStates.AVAILABLE) return -1;
    return this._getTimestamp() - this._availableAt;
  }
}

module.exports = PooledObject;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a> on Fri Apr 17 2020 13:41:10 GMT+1000 (Australian Eastern Standard Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
